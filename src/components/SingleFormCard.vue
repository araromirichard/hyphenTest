<template>
  <div>
    <v-item-group>
      <v-container>
        <v-row>
          <v-col
            v-for="(card, j) in formCards"
            :key="j"
            cols="12"
            sm="6"
            md="4"
          >
            <v-item v-slot:default="{ active, toggle }">
              <v-skeleton-loader width="100%" type="card" :loading="loading">
                <v-card
                  width="100%"
                  @click="toggle"
                  :elevation="active ? 4 : 0"
                  class="
                    d-flex
                    align-text-center
                    flex-column
                    rounded
                    elevation-0
                  "
                  tile
                  style="
                    width: auto;
                    height: 200px;
                    background: #ffffff;
                    border: 1px solid rgba(49, 27, 146, 0.2);
                    box-sizing: border-box;
                    border-radius: 8px;
                  "
                >
                  <v-card-title
                    class="mx-2 mt-4 text-break"
                    style="
                      max-width: 90%;
                      font-family: Inter;
                      font-style: normal;
                      font-weight: 400;
                      font-size: 14px;
                      line-height: 24px;
                      color: #596a73;
                    "
                    >{{ card.form_title }}</v-card-title
                  >
                  <div class="d-flex justify-space-between my-4">
                    <div class="mx-4 mx-md-1">
                      <v-chip
                        label
                        small
                        dark
                        color="#636b70"
                        class="mt-4 mx-md-5"
                        >{{ numFormEntries }}</v-chip
                      >
                      <h5 class="mx-md-5 text--disabled">entries</h5>
                    </div>
                    <v-switch
                      class="pt-0"
                      hide-details="true"
                      dense
                      :value="card.switchValue"
                      v-model="switch1"
                      color="#16BE98"
                    ></v-switch>
                  </div>
                  <div
                    class="d-flex"
                    style="
                      margin-top: 30px;
                      width: 100%;
                      height: 48px;
                      position: absolute;
                      bottom: 0;
                      border-top: 1px solid rgba(49, 27, 146, 0.2);
                      box-sizing: border-box;
                    "
                  >
                    <p
                      class="ml-4 primary--text"
                      style="
                        font-family: Inter;
                        font-style: normal;
                        font-weight: normal;
                        font-size: 12px;
                        line-height: 18px;
                        letter-spacing: 0.45px;
                        mix-blend-mode: normal;
                        opacity: 0.5;
                      "
                      :style="{
                        marginTop: `${
                          $vuetify.breakpoint.md ? '0.7em' : '1.2em'
                        }`,
                      }"
                    >
                      Created {{ createdAt }}
                    </p>
                    <v-spacer></v-spacer>
                    <v-btn
                      v-model="selectedIcon"
                      @click="showForm(icon, index, j)"
                      target="_blank"
                      class="px-0 mx-0"
                      style="margin-top: 4px"
                      icon
                      id="no-background-hover"
                      v-for="(icon, index) in icons"
                      :key="icon.title"
                    >
                      <v-icon
                        v-bind:class="{ last: index === icons.length - 1 }"
                        color="#7F919B"
                        small
                        class="pl-1"
                        to="icon.path"
                      >
                        {{ icon.title }}
                      </v-icon>
                    </v-btn>
                  </div>
                </v-card>
              </v-skeleton-loader>
            </v-item>
          </v-col>
          <v-col cols="12" sm="6" md="4">
            <v-card
              class="d-flex flex-column align-center justify-center"
              color="#f8f8f8"
              max-width="100%"
              height="200"
              outlined
              style="border-color: rgba(49, 27, 146, 0.2)"
            >
              <v-card-actions class="ma-0 pa-0">
                <v-btn plain fab to="/form/create-new-form" target="_blank">
                  <simple-line-icons
                    icon="plus"
                    color="#7f919b"
                    style="
                      font-family: simple-line-icons;
                      font-style: normal;
                      font-weight: normal;
                      font-size: 45px;
                      line-height: 16px;
                      mix-blend-mode: normal;
                      opacity: 0.5;
                    "
                    no-svg
                  />
                </v-btn>
              </v-card-actions>
              <v-card-title class="ma-0 px-0">
                <p>New Form</p>
              </v-card-title>
            </v-card>
          </v-col>
        </v-row>
      </v-container>
    </v-item-group>
  </div>
</template>

<script>
import { mapActions, mapState } from "vuex";

export default {
  props: {
    createdAt: {
      type: String,
      required: true,
    },
  },
  data() {
    return {
      switch1: [],
      selectedIcon: null,
      numFormEntries: 0,
      formEntries: [],
      icons: [
        { title: "mdi-pencil-outline", path: "#" },
        { title: "mdi-format-indent-increase", path: "#" },
        { title: "mdi-delete", path: "#" },
      ],

      loading: true,
    };
  },
  methods: {
    ...mapActions("formBuilder", ["formCards", "deleteForm"]),
    showForm(icon, index, parentIndex) {
      // i = this.selectedIcon;
      // console.log({ icon, index });
      if (index === 0) {
        this.$emit("edit-form");

        this.$router.push({
          path: `/edit-form/${parentIndex + 1}`,
        });
      } else if (index === 1) {
        this.$emit("entries");
        // iterate over the formCards controls and get the name and label of each  field
        const controlsObject = this.formCards[parentIndex].data.controls;
        const nameLabelsArray = [];
        const nameArray = [];
        for (const key in controlsObject) {
          const newNameLabel = {};
          newNameLabel.name = controlsObject[key]["name"];
          newNameLabel.label = controlsObject[key]["label"];
          //push it into a new array
          nameLabelsArray.push(newNameLabel);
          nameArray.push(newNameLabel.name);
        }
        var filteredNameLabelArray = nameLabelsArray.filter(
          (item) => item.label !== "Submit" || item.name !== ""
        );
        this.$emit("send-entries", filteredNameLabelArray);
        //console.log(nameArray);
        //console.log(filteredNameLabelArray);
      } else if (index === 2) {
        //get the index of the particula form card
        //pass this index to a variable
        const id = this.$store.state.formBuilder.formCards[parentIndex].id;

        console.log(this.$store.state.formBuilder.formCards[parentIndex].id);
        this.$store.state.formBuilder.formCards.splice(parentIndex, 1);
        console.log(this.$store.state.formBuilder.formCards);

        //delete card from vue data object to reflect on UI
        // this.formCards.splice(parentIndex, 1);

        this.deleteForm(id);

        //delete from server....
        // formBuider
        //   .deleteForm(id)
        //   .then((response) => {
        //     console.log(response.data);
        //   })
        //   .catch((error) => {
        //     console.log("an error occurred: ", error.response);
        //   });
      }
    },

    newForm() {
      this.$emit("formBuilder/create-form", this.formCards);
    },
  },
  created() {
    //make skeleton loader stop
    this.loading = true;
    setTimeout(() => {
      this.loading = false;
    }, 5000);

    this.$store.dispatch("formBuilder/FetchAllForms");
    //console.log(this.$store.dispatch("formBuilder/FetchAllForms"));
    //console.log(this.$store);
  },
  computed: {
    ...mapState("formBuilder", ["formCards"]),

    getFormById() {
      return this.forms.find((form) => form.id == this.$route.params.id).id;
    },

    //total entries suppose to come from the form input endpoint
    totalEntriesNum() {
      return this.formEntries.length;
    },
  },
};
</script>

<style>
.v-input--selection-controls {
  /* margin-top: 16
px
; */
  padding-top: 4px !important;
}
</style>
